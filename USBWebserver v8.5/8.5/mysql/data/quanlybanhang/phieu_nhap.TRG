TYPE=TRIGGERS
triggers='CREATE DEFINER=`root`@`localhost` TRIGGER `before_delete_phieu_nhap` BEFORE DELETE ON `phieu_nhap` \n    FOR EACH ROW \nBEGIN\n	DELETE FROM `chi_tiet_phieu_nhap`\n	WHERE MA_PHIEU_NHAP = OLD.MA_PHIEU_NHAP;\n		\n	DELETE FROM `xnt_hien_tai`\n	WHERE MA_PHIEU_NHAP = OLD.MA_PHIEU_NHAP;\nEND' 'CREATE DEFINER=`root`@`localhost` TRIGGER `after_insert_phieu_nhap` AFTER INSERT ON `phieu_nhap` \n    FOR EACH ROW \nBEGIN	\n	declare v_da_tao_ton_theo_ngay int(11) default 0;\n	declare v_ngay_truoc_ngay_xnt date default null;\n\n	-- Them xnt dau ngay neu chua them\n	insert into xnt_hien_tai(MA_KHO_HANG, XNTHT_NGAY)\n	select new.MA_KHO_HANG, date(new.THOI_GIAN_TAO_PHIEU_NHAP) as XNTHT_NGAY\n	from dual\n	where not exists (select * from xnt_hien_tai where MA_KHO_HANG = new.MA_KHO_HANG and XNTHT_NGAY = DATE(new.THOI_GIAN_TAO_PHIEU_NHAP));\n	\n	-- Kiem tra xem da tao ton dau ngay cho xnt chua?\n	SELECT COUNT(*) into v_da_tao_ton_theo_ngay\n	FROM chi_tiet_ton_theo_ngay \n	WHERE XNTHT_NGAY = DATE(new.THOI_GIAN_TAO_PHIEU_NHAP);\n	\n	if v_da_tao_ton_theo_ngay = 0 then  -- Neu chua tao ton dau ngay cho xnt thi tao\n		-- Lay ngay truoc do\n		select XNTHT_NGAY into v_ngay_truoc_ngay_xnt\n		from chi_tiet_ton_theo_ngay\n		where XNTHT_NGAY < DATE(new.THOI_GIAN_TAO_PHIEU_NHAP)\n		order by XNTHT_NGAY desc\n		limit 1;	\n		\n		if v_ngay_truoc_ngay_xnt is not null then  -- Neu ngay truoc do ton tai thi tao ton dau ngay cho xnt\n			-- B1 them ton dau ngay: lay gia tri xuat va nhap\n			insert into chi_tiet_ton_theo_ngay(MA_KHO_HANG, XNTHT_NGAY, MA_HANG_HOA, XNTHT_SO_LUONG_TON)\n			select MA_KHO_HANG,\n				date(new.THOI_GIAN_TAO_PHIEU_NHAP) as XNTHT_NGAY,\n				MA_HANG_HOA,\n				sum(XNTHT_SO_LUONG_NHAP) - sum(XNTHT_SO_LUONG_XUAT) as XNTHT_SO_LUONG_TON\n			from chi_tiet_xnt_hien_tai\n			where XNTHT_NGAY = v_ngay_truoc_ngay_xnt\n			group by MA_KHO_HANG, MA_HANG_HOA;\n			\n			-- B2 them ton dau ngay: lay gia tri ton ngay truoc\n			update chi_tiet_ton_theo_ngay ttn\n			set ttn.XNTHT_SO_LUONG_TON = ttn.XNTHT_SO_LUONG_TON + ifnull((select ttn2.XNTHT_SO_LUONG_TON \n										from chi_tiet_ton_theo_ngay ttn2 \n										where ttn2.MA_KHO_HANG = ttn.MA_KHO_HANG\n											and ttn2.XNTHT_NGAY = v_ngay_truoc_ngay_xnt\n											and ttn2.MA_HANG_HOA = ttn1.MA_HANG_HOA\n										limit 1), 0)\n			where ttn.XNTHT_NGAY = date(new.THOI_GIAN_TAO_PHIEU_NHAP);				\n		end if;\n	end if;\nEND'
sql_modes=0 0
definers='root@localhost' 'root@localhost'
client_cs_names='utf8' 'utf8'
connection_cl_names='utf8_general_ci' 'utf8_general_ci'
db_cl_names='utf8_general_ci' 'utf8_general_ci'
